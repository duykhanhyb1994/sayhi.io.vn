<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Chat Home</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f6f7fb;
      margin: 0;
      padding: 24px;
    }
    .container {
      max-width: 760px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.06);
    }
    h1 { margin: 0 0 8px; font-size: 20px; }
    .top-actions { display:flex; gap:12px; align-items:center; margin-bottom:16px; }
    .btn {
      display:inline-block; padding:8px 12px; border-radius:8px; text-decoration:none;
      background:#007bff;color:#fff;font-weight:600;
    }
    form { display:flex; gap:8px; align-items:center; margin-bottom:16px; }
    input[type="text"] {
      flex:1; padding:10px 12px; border-radius:8px; border:1px solid #e0e0e0;
      font-size:15px;
    }
    button[type="submit"] {
      padding:10px 14px; border-radius:8px; border:none; background:#0068ff; color:#fff;
      font-weight:600; cursor:pointer;
    }
    .rooms { margin-top:12px; }
    .room-item {
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 12px; border-radius:8px; background:#fafafa; margin-bottom:8px;
      text-decoration:none; color:inherit;
      border:1px solid #f0f0f0;
    }
    .meta { color:#666; font-size:13px; display:flex; gap:8px; align-items:center; }
    .room-link { text-decoration:none; color:inherit; display:flex; gap:10px; align-items:center; }
    .lock { color:#d9534f; font-weight:700; margin-left:6px; }
    .small { font-size:13px; color:#666; }
    .delete-link {
      color:red; text-decoration:none; font-weight:bold;
    }
    .delete-link:hover { opacity:0.7; }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-actions">
      <h1>Xin ch√†o, {{ user.username }}!</h1>
      <a class="btn" href="{% url 'create_room' %}">‚ûï T·∫°o ph√≤ng m·ªõi</a>
    </div>

    <p class="small">Nh·∫≠p t√™n ph√≤ng ƒë·ªÉ tham gia (ho·∫∑c ch·ªçn ph√≤ng trong danh s√°ch):</p>

    <form id="room-form" onsubmit="return joinRoom(event)">
      <input type="text" name="room_name" id="room-name-input" placeholder="T√™n ph√≤ng (v√≠ d·ª•: room1)" autocomplete="off" />
      <button type="submit">Tham gia</button>
    </form>

    <div class="rooms">
      {% if rooms %}
        {% for room in rooms %}
          <div class="room-item">
            <a class="room-link" href="{% url 'room' room.name %}">
              <span>{{ room.name }}</span>
              {% if room.password %}
                <span class="lock">üîí</span>
              {% else %}
                <span class="meta">üåê C√¥ng khai</span>
              {% endif %}
            </a>
            <div class="meta">
              <span>üë• {{ room.members.count }} th√†nh vi√™n</span>
              {% if user == room.created_by or user.is_superuser %}
                <a class="delete-link" href="{% url 'delete_room' room.name %}"
                   onclick="return confirm('üóëÔ∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ph√≤ng {{ room.name }} kh√¥ng?');">
                   üóëÔ∏è X√≥a
                </a>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p>Ch∆∞a c√≥ ph√≤ng n√†o. H√£y t·∫°o ph√≤ng m·ªõi.</p>
      {% endif %}
    </div>
  </div>

  <script>
    function sanitizeRoomName(name) {
      // lo·∫°i b·ªè kho·∫£ng tr·∫Øng ƒë·∫ßu/cu·ªëi v√† k√Ω t·ª± ƒë·∫∑c bi·ªát
      return name.trim().replace(/\/+/g, "").replace(/[^a-zA-Z0-9_\-\u00C0-\u017F ]/g, "");
    }

    function joinRoom(e) {
      e.preventDefault();
      const input = document.getElementById('room-name-input');
      const raw = input.value;
      const roomName = sanitizeRoomName(raw);

      if (!roomName) {
        alert("Vui l√≤ng nh·∫≠p t√™n ph√≤ng!");
        return false;
      }

      window.location.href = `/chat/room/${encodeURIComponent(roomName)}/`;
      return false;
    }
  </script>
</body>
</html>
